# Render Blueprint Configuration
# https://render.com/docs/blueprint-spec

databases:
  - name: agent-k-postgres
    plan: basic-256mb
    databaseName: agent_k_db
    user: agent_k
    region: oregon

services:
  # FastAPI Backend
  - type: web
    name: agent-k-api
    branch: main
    plan: starter
    region: oregon
    runtime: python
    buildCommand: |
      cd backend &&
      pip install --upgrade pip &&
      pip install -e .
    startCommand: |
      cd backend &&
      uvicorn agent_k.ui.ag_ui.app:create_app --factory --host 0.0.0.0 --port $PORT
    healthCheckPath: /health
    envVars:
      - key: PYTHON_VERSION
        value: "3.12.0"
      - fromGroup: agent-k-secrets

  # Next.js Frontend
  - type: web
    name: agent-k-frontend
    branch: main
    plan: starter
    region: oregon
    runtime: node
    buildCommand: |
      cd frontend &&
      npm install -g pnpm &&
      pnpm install --frozen-lockfile &&
      pnpm run build
    preDeployCommand: cd frontend && pnpm run db:migrate
    startCommand: |
      cd frontend &&
      pnpm start
    envVars:
      - key: NODE_VERSION
        value: "20"
      - key: POSTGRES_URL
        fromDatabase:
          name: agent-k-postgres
          property: connectionString
      - key: NEXT_PUBLIC_API_URL
        value: "https://agent-k-api.onrender.com"
      # === AUTH.JS REQUIRED VARIABLES ===
      - key: AUTH_SECRET
        generateValue: true
      - key: AUTH_TRUST_HOST
        value: "true"
      - key: AUTH_URL
        value: "https://agent-k-frontend.onrender.com"
