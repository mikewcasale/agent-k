# Render Infrastructure as Code - AutoMatter Project
# This file defines the complete deployment configuration for Render
# Environments:
#   - UAT: Deploys from 'uat' branch
#   - Production: Deploys from 'main' branch
#
# NOTE: Environment variables are managed via service-level env vars using Render API.
#       Use scripts/sync_all_render_envs.py to sync from render-environment-groups/*.env
#       Only service-specific dynamic values (DATABASE_URL, NEXT_PUBLIC_API_BASE_URL)
#       are defined in this file.
#
# IMPORTANT: After updating env files, run: python3 scripts/sync_all_render_envs.py

databases:
  # UAT Database
  - name: automatter-postgres
    plan: Basic-1gb
    postgresMajorVersion: 15
    user: automatter
    region: oregon

  # Production Database
  - name: prod-automatter-postgres
    plan: Basic-1gb
    postgresMajorVersion: 15
    user: automatter
    region: oregon

services:
  # ================================
  # UAT ENVIRONMENT (uat branch)
  # ================================
  
  # UAT Backend API Service
  - type: web
    name: automatter-backend
    branch: uat
    plan: standard
    region: oregon
    runtime: python
    buildCommand: |
      cd backend &&
      pip install --upgrade pip &&
      pip install -r requirements.txt
    startCommand: |
      cd backend &&
      python -c "import sys; print('Python version:', sys.version); print('Starting UAT backend...')" &&
      uvicorn api.main:app --host 0.0.0.0 --port $PORT --workers 4
    healthCheckPath: /health
    envVars:
      # Database connection (automatically populated by Render)
      - key: DATABASE_URL
        fromDatabase:
          name: automatter-postgres
          property: connectionString

  # UAT Background Worker Service
  - type: worker
    name: automatter-worker
    branch: uat
    plan: starter
    region: oregon
    runtime: python
    buildCommand: |
      cd backend &&
      pip install --upgrade pip &&
      pip install -r requirements.txt
    startCommand: |
      cd backend &&
      python worker.py
    envVars:
      # Database connection (automatically populated by Render)
      - key: DATABASE_URL
        fromDatabase:
          name: automatter-postgres
          property: connectionString

  # UAT Frontend Static Site
  - type: web
    name: automatter-frontend
    branch: uat
    plan: starter
    region: oregon
    runtime: node
    buildCommand: |
      cd frontend &&
      npm ci &&
      npm install --no-save lightningcss-linux-x64-gnu @tailwindcss/oxide-linux-x64-gnu@4.1.11 &&
      cp node_modules/lightningcss-linux-x64-gnu/lightningcss.linux-x64-gnu.node node_modules/lightningcss/ 2>/dev/null || true &&
      npm run build
    startCommand: |
      cd frontend &&
      npm start
    envVars:
      # Frontend-specific dynamic URL (automatically populated by Render)
      - key: NEXT_PUBLIC_API_BASE_URL
        fromService:
          type: web
          name: automatter-backend
          property: url
      # HTTP Basic Auth credentials
      - key: BASIC_AUTH_USER
        value: admin
      - key: BASIC_AUTH_PASSWORD
        value: automatter_dev_2025

  # ================================
  # PRODUCTION ENVIRONMENT (main branch)
  # ================================

  # Production Backend API Service
  - type: web
    name: prod-automatter-backend
    branch: main
    plan: standard
    region: oregon
    runtime: python
    buildCommand: |
      cd backend &&
      pip install --upgrade pip &&
      pip install -r requirements.txt
    startCommand: |
      cd backend &&
      python -c "import sys; print('Python version:', sys.version); print('Starting Production backend...')" &&
      uvicorn api.main:app --host 0.0.0.0 --port $PORT --workers 4
    healthCheckPath: /health
    envVars:
      # Database connection (automatically populated by Render)
      - key: DATABASE_URL
        fromDatabase:
          name: prod-automatter-postgres
          property: connectionString

  # Production Background Worker Service
  - type: worker
    name: prod-automatter-worker
    branch: main
    plan: starter
    region: oregon
    runtime: python
    buildCommand: |
      cd backend &&
      pip install --upgrade pip &&
      pip install -r requirements.txt
    startCommand: |
      cd backend &&
      python worker.py
    envVars:
      # Database connection (automatically populated by Render)
      - key: DATABASE_URL
        fromDatabase:
          name: prod-automatter-postgres
          property: connectionString

  # Production Frontend Static Site
  - type: web
    name: prod-automatter-frontend
    branch: main
    plan: starter
    region: oregon
    runtime: node
    buildCommand: |
      cd frontend &&
      npm ci &&
      npm install --no-save lightningcss-linux-x64-gnu @tailwindcss/oxide-linux-x64-gnu@4.1.11 &&
      cp node_modules/lightningcss-linux-x64-gnu/lightningcss.linux-x64-gnu.node node_modules/lightningcss/ 2>/dev/null || true &&
      npm run build
    startCommand: |
      cd frontend &&
      npm start
    envVars:
      # Frontend-specific dynamic URL (automatically populated by Render)
      - key: NEXT_PUBLIC_API_BASE_URL
        fromService:
          type: web
          name: prod-automatter-backend
          property: url
      # HTTP Basic Auth credentials
      - key: BASIC_AUTH_USER
        value: admin
      - key: BASIC_AUTH_PASSWORD
        value: automatter_dev_2025

  # ================================
  # CRON JOBS
  # ================================

  # Production Qualia Order Sync (hourly)
  - type: cron
    name: prod-qualia-order-sync
    branch: main
    plan: starter
    region: oregon
    runtime: python
    schedule: "0 * * * *"  # Every hour
    buildCommand: |
      cd backend &&
      pip install --upgrade pip &&
      pip install -r requirements.txt
    startCommand: |
      cd backend &&
      python scripts/sync_qualia_orders_continuous.py --hours-back 2 --database-url $DATABASE_URL
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: prod-automatter-postgres
          property: connectionString

# Preview environments for pull requests
previewsEnabled: true
