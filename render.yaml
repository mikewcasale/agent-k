# Render Blueprint Configuration
# https://render.com/docs/blueprint-spec

databases:
  - name: agent-k-postgres
    plan: basic_256mb
    databaseName: agent_k_db
    user: agent_k
    region: oregon

services:
  # FastAPI Backend
  - type: web
    name: agent-k-api
    branch: main
    plan: starter
    region: oregon
    runtime: python
    buildCommand: |
      cd backend &&
      pip install --upgrade pip &&
      pip install -e .
    startCommand: |
      cd backend &&
      uvicorn agent_k.ui.ag_ui.app:app --host 0.0.0.0 --port $PORT
    healthCheckPath: /health
    envVars:
      - key: PYTHON_VERSION
        value: "3.12"
      - fromGroup: agent-k-secrets

  # Next.js Frontend
  - type: web
    name: agent-k-frontend
    branch: main
    plan: starter
    region: oregon
    runtime: node
    buildCommand: |
      cd frontend &&
      npm ci --legacy-peer-deps &&
      npm run build
    preDeployCommand: cd frontend && npm run db:migrate
    startCommand: |
      cd frontend &&
      npm start
    envVars:
      - key: NODE_VERSION
        value: "20"
      - key: POSTGRES_URL
        fromDatabase:
          name: agent-k-postgres
          property: connectionString
      - key: NEXT_PUBLIC_API_URL
        fromService:
          type: web
          name: agent-k-api
          property: url
      # === AUTH.JS REQUIRED VARIABLES ===
      - key: AUTH_SECRET
        generateValue: true
      - key: AUTH_TRUST_HOST
        value: "true"
      - key: AUTH_URL
        value: "https://agent-k-frontend.onrender.com"
